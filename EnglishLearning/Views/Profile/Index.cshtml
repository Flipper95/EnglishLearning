@model EnglishLearning.Models.User
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section styles{
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/regular.css" integrity="sha384-z3ccjLyn+akM2DtvRQCXJwvT5bGZsspS4uptQKNXNg778nyzvdMqiGcqHVGiAUyY" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/fontawesome.css" integrity="sha384-u5J7JghGz0qUrmEsWzBQkfvc8nK3fUT7DCaQzNQ+q4oEXhGSx+P2OqjWsfIRB8QT" crossorigin="anonymous">
}

@helper DifficultDropDown(string name, string currentValue) {
     @Html.DropDownList(name, new SelectList(new[] { "Beginner", "Elementary", "Intermediate", "Upper-Intermediate", "Advanced", "Proficient" }, currentValue), new { @class = "form-control" })
}
<h2>Index</h2>

<a class="btn btn-purple text-white" href="@Url.Action("Index", "Manage", new { area = ""})">Керувати паролем</a>
<hr>
<div class="d-flex flex-row flex-wrap">
    <dl class="col-6">

        <dt>Рівень знань по граматиці:</dt>
        <dd>
            @Model.ObjectiveLevel
            <br>
            <a class="btn btn-purple" href="@Url.Action("TestUserGrammar", new { area = "", id = Model.UserId})">
            Підвищити <i class="far fa-caret-square-up fa-lg ml-2"></i>
            </a>
        </dd>
        <dt>Рівень знань по написання тексту зі слів:</dt>
        <dd>
        <dd>
            @Model.ObjLvlWriting
            <br>
            <a class="btn btn-purple" href="@Url.Action("TestUserWriting", new { area = "", id = Model.UserId})">
                Підвищити <i class="far fa-caret-square-up fa-lg ml-2"></i>
            </a>
        </dd>
        <dt>Рівень знань по сприйняттю на слух:</dt>
        <dd>
        <dd>
            @Model.ObjLvlListening
            <br>
            <a class="btn btn-purple" href="@Url.Action("TestUserListening", new { area = "", id = Model.UserId})">
                Підвищити <i class="far fa-caret-square-up fa-lg ml-2"></i>
            </a>
        </dd>
        <dt>Рівень знань по читанню</dt>
        <dd>
            @Model.ObjLvlReading
            <br>
            <a class="btn btn-purple" href="@Url.Action("TestUserReading", new { area = "", id = Model.UserId})">
                Підвищити <i class="far fa-caret-square-up fa-lg ml-2"></i>
            </a>
        </dd>
    </dl>

    @using (Html.BeginForm("EditUserLvl", "Profile", FormMethod.Post, new { @class="col-6"}))
    {
        @Html.HiddenFor(x => x.UserId)
        <dl>

            <dt>Рівень знань по граматиці:</dt>
            <dd>
                @DifficultDropDown("Level", Model == null ? "Beginner" : (Model.Level ?? "Beginner"))
            </dd>
            <dt>Рівень знань по написання тексту зі слів:</dt>
            <dd>
            <dd>
                @DifficultDropDown("LvlWriting", Model == null ? "Beginner" : (Model.LvlWriting ?? "Beginner"))
            </dd>
            <dt>Рівень знань по сприйняттю на слух:</dt>
            <dd>
            <dd>
                @DifficultDropDown("LvlListening", Model == null ? "Beginner" : (Model.LvlListening ?? "Beginner"))
            </dd>
            <dt>Рівень знань по читанню:</dt>
            <dd>
                @DifficultDropDown("LvlReading", Model == null ? "Beginner" : (Model.LvlReading ?? "Beginner"))
            </dd>
        </dl>
        <button type="submit" class="btn btn-purple">Зберегти</button>
    }
</div>
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link bg-secondary text-light active" id="standard-tab" data-toggle="tab" href="#standard" role="tab" aria-controls="standard" aria-selected="true">Стандартні завдання</a>
    </li>
    <li class="nav-item">
        <a class="nav-link bg-secondary text-light" id="user-tab" data-toggle="tab" href="#user" role="tab" aria-controls="user" aria-selected="false">Власні завдання</a>
    </li>
</ul>
<div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="standard" role="tabpanel" aria-labelledby="beginner-tab">
        <div class="card-columns">        </div>
            @Html.Action("ShowTasks", new { area = "", type = "Standard" })
    </div>
    <div class="tab-pane fade" id="user" role="tabpanel" aria-labelledby="elementary-tab">
        <a id="create" class="btn text-info" data="@Url.Action("CreateTaskModal", "ManageELTasks", new { area = "Moderator"})"><i class="far fa-plus-square fa-2x"></i></a>
        <div class="card-columns"> </div>
        <div id="userTasks">
            @Html.Action("ShowTasks", new { area = "", type = "User" })
        </div>
    </div>
</div>

<div id="editBody"></div>
<div id="createBody"></div>
<div id="editUTBody"></div>

<script>
    $("#myTabContent").on("click", ".close-btn", function (e) {
        e.stopPropagation();
        var el = $(this);
        var parent = $(this).parent(".alert");
        var link = parent.attr("data");
        var id = parent.attr("id");
        $.ajax({
            type: "POST",
            url: link,
            data: { id: id },
            beforeSend: function () {
                return confirm("Ви точно хочете видалити завдання?");
            },
            success: function () {
                //el.prop("data-dismiss", "alert");
                //el.prop("aria-label", "Close");
                //el.parent(".alert").alert('close');
                parent.remove();
                //parent.alert('close');
            }
        })
    });

    $("#myTabContent").on("click", ".fa-edit", function (e) {
        //e.stopPropagation();
        //var id = $(this).parent(".alert").attr("data-target");
        //var link = $(this).attr("data");
        //var el = $(this);
        ////$(id).modal('hide');
        //$.ajax({
        //    type: "GET",
        //    url: link,
        //    //data: { id: id },
        //    beforeSend: function () {
        //        el.addClass("fa-spin disabled");
        //        el.attr("disabled");
        //    },
        //    success: function (data) {
        //        el.removeClass("fa-spin disabled");
        //        el.removeAttr("disabled");
        //        $("#editBody").html(data);
        //        $("#editModal").modal('show');
        //    }
        //})
        actionClick($(this), e, "#editBody", "#editModal");
    });

    var actionClick = function (el, event, bodyId, modalId) {
        event.stopPropagation();
        var link = el.attr("data");
        $.ajax({
            type: "GET",
            url: link,
            beforeSend: function () {
                el.addClass("fa-spin disabled");
                el.attr("disabled");
            },
            success: function (data) {
                el.removeClass("fa-spin disabled");
                el.removeAttr("disabled");
                $(bodyId).html(data);
                $(modalId).modal('show');
            }
        })
    }

    var hideModal = function (formId, modalId) {
        $(formId).submit();
        $(modalId).modal('hide');
        $('body').removeClass('modal-open');
        $(modalId).remove();
        $('.modal-backdrop').remove();
    }

    $("#editBody").on("click", "#EditSubmit", function () {
        //$("#EditForm").submit();
        //$("#editModal").modal('hide');
        //$('body').removeClass('modal-open');
        //$("#editModal").remove();
        //$('.modal-backdrop').remove();
        ////$("#editModal").remove();
        var id = $("#TaskId").prop("value");
        var elem = document.getElementById("EditForm");
        var data = new FormData(elem);
        //data.append("file", $("#file")[0].files[0]);
        //data.append("Name", $("#Name")[0].prop("text"));
        //data.append("Description", $("#Description")[0].prop("text"));
        //data.append("Text", $("#Text")[0].prop("text"));
        //data.append("Group", $("#Group")[0].prop("text"));
        //data.append("DocumentPath", $("#DocumentPath")[0].prop("text"));
        //data.append("Difficult", $("#Difficult")[0].prop("value"));
        $.ajax({
            type: "POST",
            url: $("#EditForm").prop("action"),
            data: data,
            success: function (data) {
                $("#editModal").modal('hide');
                $('body').removeClass('modal-open');
                $("#editModal").remove();
                $('.modal-backdrop').remove();
                if (data) {
                    $("#"+id).children(".TaskName").text(data);
                }
            },
            cache: false,
            contentType: false,
            processData: false
        })
        //hideModal("#EditForm", "#editModal");
    });

    $("#myTabContent").on("click", "#create", function (e) {
        //e.stopPropagation();
        //var link = $(this).attr("data");
        //var el = $(this);

        //$.ajax({
        //    type: "GET",
        //    url: link,
        //    beforeSend: function () {
        //        el.addClass("fa-spin disabled").attr("disabled", true);
        //    },
        //    success: function (data) {
        //        el.removeClass("fa-spin disabled").removeAttr("disabled");
        //        $("#createBody").html(data);
        //        $("#createModal").modal('show');
        //    }
        //})
        actionClick($(this), e, "#createBody", "#createModal");
    });

    $("#createBody").on("click", "#CreateSubmit", function () {
        //$("#CreateForm").submit();
        //$("#createModal").modal('hide');
        //$('body').removeClass('modal-open');
        //$("#createModal").remove();
        //$('.modal-backdrop').remove();
        hideModal("#CreateForm", "#createModal");
        setTimeout(function () {
            location.reload();
        }, 2000);
        // or can use ajax to reload, but not sure it helps
        //location.reload();
    });

    $("#myTabContent").on("click", "#userTaskEdit", function (e) {
        //e.stopPropagation();
        //var link = $(this).attr("data");
        //var el = $(this);

        //$.ajax({
        //    type: "GET",
        //    url: link,
        //    beforeSend: function () {
        //        el.addClass("fa-spin disabled").attr("disabled", true);
        //    },
        //    success: function (data) {
        //        el.removeClass("fa-spin disabled").removeAttr("disabled");
        //        $("#editUTBody").html(data);
        //        $("#editUTModal").modal('show');
        //    }
        //})
        actionClick($(this), e, "#editUTBody", "#editUTModal");
    });

    $("#editUTBody").on("click", "#EditUTSubmit", function () {
        //$("#EditUTForm").submit();
        //$("#editUTModal").modal('hide');
        //$('body').removeClass('modal-open');
        //$("#editUTModal").remove();
        //$('.modal-backdrop').remove();
        hideModal("#EditUTForm", "#editUTModal");
        setTimeout(function () {
            location.reload();
        }, 2000);
    });
</script>
    @Scripts.Render("~/bundles/ajax")

